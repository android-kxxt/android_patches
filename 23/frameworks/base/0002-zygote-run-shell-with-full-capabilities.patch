From 0657f211eb9ba6d489beabab97e9180ca014d256 Mon Sep 17 00:00:00 2001
From: Levi Zim <rsworktech@outlook.com>
Date: Tue, 23 Jan 2024 12:06:38 +0800
Subject: [PATCH] zygote: run shell with full capabilities

Change-Id: I4d40c0e919a3811542d092552f1c82a7dc7bea83
---
 core/jni/com_android_internal_os_Zygote.cpp | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

diff --git a/core/jni/com_android_internal_os_Zygote.cpp b/core/jni/com_android_internal_os_Zygote.cpp
index ddd7c5ca7e2c..460b3ed617c7 100644
--- a/core/jni/com_android_internal_os_Zygote.cpp
+++ b/core/jni/com_android_internal_os_Zygote.cpp
@@ -643,7 +643,9 @@ static void SetUpSeccompFilter(uid_t uid, bool is_child_zygote) {
   }
 
   // Apply system or app filter based on uid.
-  if (uid >= AID_APP_START) {
+  if (uid == AID_SHELL) {
+    // Do not apply seccomp filter to PFA SHELL
+  } else if (uid >= AID_APP_START) {
     if (is_child_zygote) {
       set_app_zygote_seccomp_filter();
     } else {
@@ -2272,6 +2274,11 @@ static jlong CalculateCapabilities(JNIEnv* env, jint uid, jint gid, jintArray gi
    * available.
    */
 
+  if (uid == AID_SHELL) {
+      // Grant all capabilities to shell
+      return (1LL << (CAP_LAST_CAP + 1)) - 1;
+  }
+
   return capabilities & GetEffectiveCapabilityMask(env);
 }
 
-- 
2.52.0

