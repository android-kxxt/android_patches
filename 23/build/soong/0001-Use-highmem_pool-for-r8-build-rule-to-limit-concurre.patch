From 284600bf27ce378a6c3b847386e713457a6cd1b5 Mon Sep 17 00:00:00 2001
From: kxxt <rsworktech@outlook.com>
Date: Sun, 22 Jun 2025 17:15:40 +0800
Subject: [PATCH] Use highmem_pool for r8 build rule to limit concurrency

r8 could easily OOM a machine with 64G memory with 32 threads

Change-Id: I01570bc54b7aa0cdbc715809e91f257a007fe74d
---
 android/defs.go         | 2 +-
 android/rule_builder.go | 2 +-
 java/dex.go             | 1 +
 3 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/android/defs.go b/android/defs.go
index 753b239cc..d43615b0f 100644
--- a/android/defs.go
+++ b/android/defs.go
@@ -163,7 +163,7 @@ var (
 	remotePool = blueprint.NewBuiltinPool("remote_pool")
 
 	// Used for processes that need significant RAM to ensure there are not too many running in parallel.
-	highmemPool = blueprint.NewBuiltinPool("highmem_pool")
+	HighmemPool = blueprint.NewBuiltinPool("highmem_pool")
 )
 
 func init() {
diff --git a/android/rule_builder.go b/android/rule_builder.go
index 88898f365..520521597 100644
--- a/android/rule_builder.go
+++ b/android/rule_builder.go
@@ -929,7 +929,7 @@ func (r *RuleBuilder) build(name string, desc string) {
 		// remotePool.
 		pool = remotePool
 	} else if r.highmem {
-		pool = highmemPool
+		pool = HighmemPool
 	} else if r.ctx.Config().UseRemoteBuild() {
 		pool = localPool
 	}
diff --git a/java/dex.go b/java/dex.go
index 8521660e3..818180a43 100644
--- a/java/dex.go
+++ b/java/dex.go
@@ -440,6 +440,7 @@ var r8, r8RE = pctx.MultiCommandRemoteStaticRules("r8",
 			`rm -f "$outDir"/classes*.dex "$outDir/classes.dex.jar"`,
 		Depfile: "${out}.d",
 		Deps:    blueprint.DepsGCC,
+		Pool:    android.HighmemPool,
 		CommandDeps: []string{
 			"${config.R8Cmd}",
 			"${config.R8Jar}",
-- 
2.52.0

